---
- hosts: PROD
  remote_user: root
  vars:
    web_2009_dir: "/data/apache/serve/echaloasuerte/2009/"
    web_2011_dir: "/data/apache/serve/echaloasuerte/2011/"
  tasks:

  - name: Install packages needed from apt
    apt:
      pkg: "{{ item }}"
      state: present
    with_items:
    - git
    - gettext
    - apache2
    - libapache2-mod-php5
    - mariadb-server
    - python-mysqldb
    - php5-mysql

  - name: Remove apache default
    file:
        path: "/etc/apache2/sites-enabled/000-default.conf"
        state: absent

  - name: Create a database user (for the first run only)
    mysql_user: name=root password=toor priv=*.*:ALL host=localhost state=present
    ignore_errors: yes

  - name: Create a new database
    mysql_db: name=echaloasuerte state=present collation=utf8_general_ci login_user=root login_password=toor

  - name: Create tables
    shell: cat echloasuerte_legacy/create_db.sql | mysql -u root -ptoor echaloasuerte

  - name: Create echaloasuerte application tree
    file:
      path: "{{ item }}"
      state: directory
      owner: www-data
      recurse: yes
    with_items:
    - "{{ web_2011_dir }}/logs"
    - "{{ web_2011_dir }}/app"
    - "{{ web_2009_dir }}/logs"
    - "{{ web_2009_dir }}/app"

  - name: Clone/update repository in {{ app_root_dir }}
    git:
      repo: git://github.com/etcaterva/Echaloasuerte_legacy.git
      dest: "{{ app_root_dir }}/app"
      update: yes
      accept_hostkey: True
      force: yes

  - name: Fix owners of echaloasuerte application tree
    file:
      path: "{{ item }}"
      state: directory
      owner: www-data
      recurse: yes
    with_items:
    - "{{ web_2011_dir }}/logs"
    - "{{ web_2011_dir }}/app"
    - "{{ web_2009_dir }}/logs"
    - "{{ web_2009_dir }}/app"

  - name: Create the apache config file
    template:
      src: echaloasuerte_legacy/apache_website.conf
      dest: /etc/apache2/sites-available/echaloasuerte_legacy.conf
    notify:
    - restart apache

  - name: Enable apache site ecaheloasuerte
    file:
      src: ../sites-available/echaloasuerte_legacy.conf
      dest: /etc/apache2/sites-enabled/echaloasuerte_legacy.conf
      state: link
    notify:
    - restart apache

  - name: Ensure apache is running
    service:
      name: apache2
      state: started

  handlers:
    - name: restart apache
      service:
        name: apache2
        state: restarted
        sleep: 5
